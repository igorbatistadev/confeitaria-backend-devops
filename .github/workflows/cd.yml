name: ‚öôÔ∏è Update Helm Chart Image Version

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "New Docker image tag (commit SHA)"
        required: true
        type: string
      image_repo:
        description: "New Docker image repository path"
        required: true
        type: string

jobs:
  update-helm:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üìù Update Helm values.yaml
        run: |
          VALUES_FILE="helm/confeitaria-backend-devops/values.yaml"
          NEW_TAG="${{ github.event.inputs.image_tag }}"
          NEW_REPO="${{ github.event.inputs.image_repo }}"

          sudo apt-get update && sudo apt-get install -y yq

          yq e ".image.repository = \"${NEW_REPO}\"" -i $VALUES_FILE
          yq e ".image.tag = \"${NEW_TAG}\"" -i $VALUES_FILE

          echo "Atualizado $VALUES_FILE com tag: $NEW_TAG"

      - name: üíæ Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(helm): Bumping image version to ${{ github.event.inputs.image_tag }} [skip ci]"
          commit_user_name: GitHub Actions
          commit_user_email: actions@github.com
          branch: main 
